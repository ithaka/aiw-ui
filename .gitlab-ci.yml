stages:
  - build-app
  - build-image
  - deploy

default:
  tags:
    - ${ENVIRONMENT}-runner

include:
  - file: /build-image/template.yml
    project: capstan/pow/gitlab-templates
    ref: build-image-v3.0.4

variables:
  APP_NAME: artstor-ui
  PIPELINE:
    description: "Choose pipeline"
    value: ""
    options:
      - "deploy"
  ENVIRONMENT:
    description: "Choose environment"
    value: "test"
    options:
      - "test"
      - "prod"

build-app:
  stage: build-app
  image: docker-virtual.artifactory.acorn.cirrostratus.org/node:11.0.0
  script:
    - yarn install
    - yarn build:ssr:$ENVIRONMENT
  rules:
    - if: $PIPELINE == 'deploy'
      when: always
  artifacts:
    paths:
      - $CI_PROJECT_DIR/dist/

build-image:
  stage: build-image
  extends: .build-image
  needs:
    - job: build-app
      artifacts: true
  rules:
    - if: $PIPELINE == 'deploy'
      when: always
  variables:
    CONTEXT: .
    DOCKERFILE: Dockerfile
    IMAGE_TAG: artifactory.acorn.cirrostratus.org/artstor-air-node:$CI_COMMIT_SHORT_SHA
    EXTRA_ARGS: --build-arg SAGOKU_ENV=$ENVIRONMENT

deploy:
  stage: deploy
  image: docker-virtual.artifactory.acorn.cirrostratus.org/curlimages/curl:8.00.1
  needs:
    - job: build-image
  script:
    - printenv | sort
    - curl -sSk --cookie-jar /tmp/cookie -L -F "user=$GITLAB_USER_EMAIL" -F deployId=$CI_COMMIT_SHORT_SHA -F image=$IMAGE_TAG "http://sagoku.$ENVIRONMENT.cirrostratus.org/api/docker/artstor-ui/deploy"
  rules:
    - if: $PIPELINE == 'deploy'
      when: always
  variables:
    IMAGE_TAG: artifactory.acorn.cirrostratus.org/artstor-air-node:$CI_COMMIT_SHORT_SHA
  